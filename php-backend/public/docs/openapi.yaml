openapi: 3.0.3
info:
  title: StudyStreak PHP backend API
  version: "1.0.0"
  description: >-
    Contract for StudyStreak backend endpoints including todos, gamification,
    and learning material uploads consumed by the StudyStreak frontend.
tags:
  - name: Todos
    description: Manage user todo items.
  - name: Gamification
    description: Track streaks, XP, and profile-level gamification data.
  - name: Learning Materials
    description: Upload, list, and manage shared study resources.
  - name: AI Study Tools
    description: Generate summaries, keypoints, quizzes, and flashcards from study materials.
servers:
  - url: https://studystreak-backend.onrender.com
    description: Production deployment
  - url: http://localhost:8181
    description: Local development server
  - url: http://localhost:8182
    description: Local development server (alternate - PHP built-in with raised upload limits)
  - url: http://localhost:8000
    description: AI service (local development)
paths:
  /api/todos:
    get:
      tags:
        - Todos
      summary: List todos
      description: >-
        Returns a list of todos. Optional `user_id` query parameter filters the
        result set by owner.
      parameters:
        - in: query
          name: user_id
          schema:
            type: integer
          description: Filter todos by owner id
      responses:
        '200':
          description: Successful response containing a JSON array of todos
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Todo'
        '401':
          description: Unauthorized – missing or invalid bearer token
    post:
      tags:
        - Todos
      summary: Create a todo
      description: >-
        Create a new todo. Requires an `Authorization: Bearer <user_jwt>` header
        with a valid Supabase user JWT.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NewTodo'
      security:
        - bearerAuth: []
      responses:
        '201':
          description: Created – returns the newly created todo representation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Todo'
        '401':
          description: Unauthorized – missing or invalid bearer token
  /api/gamification/profile:
    get:
      tags:
        - Gamification
      summary: Current user gamification profile
      description: >-
        Fetches the authenticated user's gamification stats (level, streak,
        experience points) from the Supabase `profiles` table.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Gamification profile for the signed-in user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GamificationProfile'
        '401':
          description: Unauthorized – missing or invalid bearer token
        '404':
          description: Profile not found
  /api/gamification/streak/activate:
    post:
      tags:
        - Gamification
      summary: Record a study activity and update streak
      description: >-
        Marks the authenticated user's streak as active for the supplied
        activity time. The backend will increment or reset the streak based on
        the user's previous activity and timezone, update the longest streak,
        and optionally add to the tracked study minutes.
      security:
        - bearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GamificationStreakActivationRequest'
      responses:
        '200':
          description: Updated streak state along with the latest profile summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GamificationStreakActivationResponse'
        '400':
          description: Invalid payload
        '401':
          description: Unauthorized – missing or invalid bearer token
        '404':
          description: Profile not found
  /api/gamification/set-timezone:
    post:
      tags:
        - Gamification
      summary: Update streak timezone
      description: >-
        Updates the authenticated user's preferred timezone, which is used for
        streak calculations and UI display.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - timezone
              properties:
                timezone:
                  type: string
                  description: IANA timezone identifier (e.g. Asia/Manila).
      responses:
        '200':
          description: Timezone updated or already set to requested value
        '400':
          description: Missing or invalid timezone value
        '401':
          description: Unauthorized – missing or invalid bearer token
        '404':
          description: Profile not found
  /api/gamification/streak/use-saver:
    post:
      tags:
        - Gamification
      summary: Consume a streak saver
      description: >-
        Uses an available streak saver for the authenticated user, preventing
        their current streak from resetting.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Streak saver consumption result with updated profile snapshot
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GamificationUseSaverResponse'
        '401':
          description: Unauthorized – missing or invalid bearer token
        '404':
          description: Profile not found or streak saver unavailable
  /api/learning-materials:
    get:
      tags:
        - Learning Materials
      summary: List learning materials
      description: >-
        Returns learning materials visible to the authenticated user. Results
        include the user's private uploads and public community resources.
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: filter
          schema:
            type: string
            enum: [all, my, community, official]
          description: Optional filter preset to control visibility scope.
        - in: query
          name: category
          schema:
            type: string
          description: Optional category slug to narrow results.
        - in: query
          name: search
          schema:
            type: string
          description: Text query applied to title, description, and tags.
      responses:
        '200':
          description: Array of learning materials ordered by newest first
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/LearningMaterial'
        '401':
          description: Unauthorized – missing or invalid bearer token
    post:
      tags:
        - Learning Materials
      summary: Upload a learning material
      description: >-
        Upload a PDF, PPT, or PPTX file (max 100 MB) and store its metadata in
        Supabase. Requires bearer authentication. Private uploads return a
        signed download URL.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - title
                - file
              properties:
                title:
                  type: string
                  description: Display name for the material.
                description:
                  type: string
                  nullable: true
                  description: Optional longer summary shown in listings.
                category:
                  type: string
                  nullable: true
                  description: Optional category label.
                tags:
                  type: string
                  nullable: true
                  description: JSON encoded array of tag strings.
                is_public:
                  type: boolean
                  description: Whether the file is visible in the community library.
                file:
                  type: string
                  format: binary
                  description: PDF, PPT, or PPTX document up to 100 MB.
      responses:
        '201':
          description: Created – metadata saved and file stored successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LearningMaterialUploadResponse'
        '400':
          description: Invalid payload or unsupported file
        '401':
          description: Unauthorized – missing or invalid bearer token
  /api/learning-materials/{id}:
    get:
      tags:
        - Learning Materials
      summary: Get a single learning material
      description: Retrieve a single material by id. Private materials require the owner or an elevated token.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Material id
      responses:
        '200':
          description: Learning material
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LearningMaterial'
        '401':
          description: Unauthorized
        '404':
          description: Not found
    patch:
      tags:
        - Learning Materials
      summary: Update a learning material
      description: Update title, description, tags or visibility. Requires authentication and ownership.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                description:
                  type: string
                  nullable: true
                is_public:
                  type: boolean
                tags:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: Updated learning material
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LearningMaterial'
        '400':
          description: Invalid payload
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
    delete:
      tags:
        - Learning Materials
      summary: Delete a learning material
      description: Soft-delete a material and remove its storage object. Requires authentication and ownership.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Deleted
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
  /api/learning-materials/{id}/signed-url:
    get:
      tags:
        - Learning Materials
      summary: Request a signed URL for a material
      description: Returns a signed URL (or direct file_url) for downloading or previewing the stored object.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
        - in: query
          name: purpose
          schema:
            type: string
            enum: [download, preview]
          description: Purpose of the signed URL
        - in: query
          name: expiresIn
          schema:
            type: integer
            default: 900
          description: Expiration in seconds (max 3600)
      responses:
        '200':
          description: Signed URL response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SignedUrlResponse'
        '401':
          description: Unauthorized
        '404':
          description: Material or object not found
  /api/learning-materials/{id}/like:
    post:
      tags:
        - Learning Materials
      summary: Like a material
      description: Record that the authenticated user likes the specified material.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Updated material with like count
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LearningMaterial'
        '401':
          description: Unauthorized
  /api/learning-materials/{id}/unlike:
    post:
      tags:
        - Learning Materials
      summary: Unlike a material
      description: Remove the authenticated user's like from the specified material.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Updated material with like count
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LearningMaterial'
        '401':
          description: Unauthorized
  /api/ai/generate/summary:
    post:
      tags:
        - AI Study Tools
      summary: Generate a summary from text
      description: >-
        Generate a concise summary from the provided text content using AI.
        Returns a structured summary with key points.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateRequest'
      responses:
        '200':
          description: Successfully generated summary
          content:
            application/json:
              schema:
                type: object
                properties:
                  summary:
                    type: string
                    example: "This text discusses the fundamentals of machine learning..."
        '400':
          description: Invalid request payload
        '500':
          description: AI generation error
  /api/ai/generate/keypoints:
    post:
      tags:
        - AI Study Tools
      summary: Generate keypoints from text
      description: >-
        Extract and generate key points from the provided text content.
        Returns a list of important concepts and ideas.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateRequest'
      responses:
        '200':
          description: Successfully generated keypoints
          content:
            application/json:
              schema:
                type: object
                properties:
                  keypoints:
                    type: array
                    items:
                      type: string
                    example: ["Neural networks are computational models", "Supervised learning uses labeled data"]
        '400':
          description: Invalid request payload
        '500':
          description: AI generation error
  /api/ai/generate/quiz:
    post:
      tags:
        - AI Study Tools
      summary: Generate a quiz from text
      description: >-
        Generate multiple-choice quiz questions from the provided text content.
        Returns a set of questions with options and correct answers.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateQuizRequest'
      responses:
        '200':
          description: Successfully generated quiz
          content:
            application/json:
              schema:
                type: object
                properties:
                  quiz:
                    type: array
                    items:
                      $ref: '#/components/schemas/QuizQuestion'
        '400':
          description: Invalid request payload
        '500':
          description: AI generation error
  /api/ai/generate/flashcards:
    post:
      tags:
        - AI Study Tools
      summary: Generate flashcards from text
      description: >-
        Generate study flashcards (question-answer pairs) from the provided text content.
        Returns a set of flashcards optimized for memorization.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateFlashcardsRequest'
      responses:
        '200':
          description: Successfully generated flashcards
          content:
            application/json:
              schema:
                type: object
                properties:
                  flashcards:
                    type: array
                    items:
                      $ref: '#/components/schemas/Flashcard'
        '400':
          description: Invalid request payload
        '500':
          description: AI generation error
  /api/ai/generate/all:
    post:
      tags:
        - AI Study Tools
      summary: Generate all study tools at once
      description: >-
        Generate summary, keypoints, quiz, and flashcards from the provided text in a single request.
        This is more efficient than making separate calls to each endpoint.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateAllRequest'
      responses:
        '200':
          description: Successfully generated all study tools
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AllStudyToolsResponse'
        '400':
          description: Invalid request payload
        '500':
          description: AI generation error
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    Todo:
      type: object
      required:
        - id
        - title
        - user_id
        - completed
      properties:
        id:
          type: integer
          example: 42
        title:
          type: string
          example: Finish TypeScript homework
        user_id:
          type: integer
          example: 123
        completed:
          type: boolean
          example: false
    NewTodo:
      type: object
      required:
        - title
        - user_id
      properties:
        title:
          type: string
          example: Finish TypeScript homework
        user_id:
          type: integer
          description: Supabase auth user id associated with the todo
          example: 123
        completed:
          type: boolean
          description: Optional initial completion state (defaults to false)
          example: false
    GamificationProfile:
      type: object
      properties:
        username:
          type: string
          nullable: true
          example: studybuddy
        streak_count:
          type: integer
          nullable: true
          example: 12
          description: Consecutive study days tracked by the system
        total_study_time:
          type: integer
          nullable: true
          example: 540
          description: Total tracked study time in minutes
        level:
          type: integer
          nullable: true
          example: 3
        experience_points:
          type: integer
          nullable: true
          example: 1250
        created_at:
          type: string
          format: date-time
          nullable: true
        streak_longest:
          type: integer
          nullable: true
          example: 25
          description: Longest streak achieved by the user
        streak_last_active_at:
          type: string
          format: date-time
          nullable: true
          description: Timestamp (UTC) when the streak was last activated
        streak_timezone:
          type: string
          nullable: true
          example: Asia/Manila
          description: IANA timezone identifier used for streak calculations
    GamificationStreakActivationRequest:
      type: object
      properties:
        occurred_at:
          type: string
          format: date-time
          description: ISO timestamp for when the study activity ended (defaults to now)
        timezone:
          type: string
          description: Preferred IANA timezone for streak evaluation (defaults to stored timezone or UTC)
          example: Asia/Manila
        study_minutes:
          type: integer
          minimum: 0
          description: Minutes of focused study to add to the cumulative total
          example: 25
        duration_minutes:
          type: integer
          minimum: 0
          description: Alias for study_minutes to maintain backwards compatibility
          example: 25
    GamificationStreakActivationResponse:
      type: object
      required:
        - profile
        - streak_was_incremented
        - streak_was_reset
        - study_minutes_applied
      properties:
        profile:
          $ref: '#/components/schemas/GamificationProfile'
        streak_was_incremented:
          type: boolean
          description: Indicates whether the streak increased by one
        streak_was_reset:
          type: boolean
          description: Indicates whether the streak was reset to 1 due to a lapse
        study_minutes_applied:
          type: integer
          description: Total minutes applied from the request payload (rounded to an integer)
    GamificationUseSaverResponse:
      type: object
      required:
        - success
        - profile
      properties:
        success:
          type: boolean
          description: Indicates whether a streak saver was successfully consumed.
        payload:
          type: object
          nullable: true
          additionalProperties: true
          description: Raw RPC response returned by the Supabase function.
        profile:
          $ref: '#/components/schemas/GamificationProfile'
    LearningMaterial:
      type: object
      properties:
        id:
          type: string
          example: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
        title:
          type: string
          example: "Anatomy Notes"
        description:
          type: string
          nullable: true
        content_type:
          type: string
          example: "pdf"
        file_url:
          type: string
          nullable: true
          example: "https://.../signed-url"
        storage_path:
          type: string
          nullable: true
          example: "user123/2025/11/02/abcd1234-notes.pdf"
        file_name:
          type: string
          nullable: true
          example: "notes.pdf"
        mime:
          type: string
          nullable: true
          example: "application/pdf"
        size:
          type: integer
          nullable: true
          example: 123456
        is_public:
          type: boolean
          example: false
        user_liked:
          type: boolean
          example: false
        likes_count:
          type: integer
          example: 3
        downloads_count:
          type: integer
          example: 12
        tags:
          type: array
          items:
            type: string
        uploader_id:
          type: string
          nullable: true
        uploader_name:
          type: string
          nullable: true
        uploader_email:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    LearningMaterialUploadResponse:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        storage_path:
          type: string
          nullable: true
        file_url:
          type: string
          nullable: true
        is_public:
          type: boolean
    SignedUrlResponse:
      type: object
      properties:
        signed_url:
          type: string
        expires_at:
          type: integer
          description: Unix timestamp when the signed URL expires
    GenerateRequest:
      type: object
      required:
        - text
      properties:
        text:
          type: string
          description: The input text content to process
          example: "Machine learning is a subset of artificial intelligence that focuses on..."
    GenerateQuizRequest:
      type: object
      required:
        - text
      properties:
        text:
          type: string
          description: The input text content to generate quiz from
        num_questions:
          type: integer
          minimum: 1
          maximum: 20
          default: 5
          description: Number of quiz questions to generate
    GenerateFlashcardsRequest:
      type: object
      required:
        - text
      properties:
        text:
          type: string
          description: The input text content to generate flashcards from
        num_flashcards:
          type: integer
          minimum: 1
          maximum: 50
          default: 10
          description: Number of flashcards to generate
    GenerateAllRequest:
      type: object
      required:
        - text
      properties:
        text:
          type: string
          description: The input text content to process
        num_quiz_questions:
          type: integer
          minimum: 1
          maximum: 20
          default: 5
          description: Number of quiz questions to generate
        num_flashcards:
          type: integer
          minimum: 1
          maximum: 50
          default: 10
          description: Number of flashcards to generate
    QuizQuestion:
      type: object
      properties:
        question:
          type: string
          example: "What is machine learning?"
        options:
          type: array
          items:
            type: string
          example: ["A subset of AI", "A programming language", "A database system", "A web framework"]
        correct_answer:
          type: string
          example: "A subset of AI"
        explanation:
          type: string
          nullable: true
          example: "Machine learning is a branch of artificial intelligence that focuses on..."
    Flashcard:
      type: object
      properties:
        question:
          type: string
          example: "What is supervised learning?"
        answer:
          type: string
          example: "A type of machine learning where the model is trained on labeled data"
        confidence:
          type: number
          format: float
          nullable: true
          description: Confidence score for the generated flashcard (0-1)
    AllStudyToolsResponse:
      type: object
      properties:
        summary:
          type: string
          example: "This text discusses machine learning fundamentals..."
        keypoints:
          type: array
          items:
            type: string
          example: ["Machine learning is a subset of AI", "Neural networks mimic brain structure"]
        quiz:
          type: array
          items:
            $ref: '#/components/schemas/QuizQuestion'
        flashcards:
          type: array
          items:
            $ref: '#/components/schemas/Flashcard'

